You are continuing development of the ZIBA ride-hailing app.
Phase 10A (Refunds & Adjustments) is COMPLETE and must NOT be altered.

IMPLEMENT PHASE 10B â€” CHARGEBACKS & EXTERNAL PAYMENT RECONCILIATION.

DO NOT BREAK EXISTING FEATURES.
EXTEND ONLY.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
OBJECTIVES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1) Track external chargebacks coming from payment processors
2) Reconcile gateway transactions with internal trips
3) Protect drivers and ZIBA from silent losses
4) Provide a finance-grade audit trail

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ROLES & PERMISSIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ADMIN
FINANCE
TRIP_COORDINATOR
RIDER
DRIVER

â€¢ RIDER: View chargeback impact only
â€¢ DRIVER: View earnings impact only
â€¢ TRIP_COORDINATOR:
   - Can flag suspicious trips
   - Can attach chargeback evidence
â€¢ FINANCE:
   - Can reconcile payments
   - Can confirm chargebacks
â€¢ ADMIN:
   - Full control (override, reverse, lock)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DATABASE (Prisma)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Add the following models:

Chargeback
- id
- tripId
- paymentProvider (STRIPE | PAYSTACK | FLUTTERWAVE | OTHER)
- externalReference
- amount
- currency
- reason
- status (REPORTED | UNDER_REVIEW | WON | LOST | REVERSED)
- reportedAt
- resolvedAt (nullable)
- createdAt

PaymentReconciliation
- id
- tripId
- expectedAmount
- actualAmount
- variance
- provider
- status (MATCHED | MISMATCHED | MANUAL_REVIEW)
- reconciledByUserId (nullable)
- createdAt

Ensure indexing on tripId and externalReference.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BUSINESS RULES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1) A Chargeback MUST:
- Reference a Trip
- Reference an external payment ID

2) When Chargeback = LOST:
- Rider wallet is debited (if possible)
- Driver payout is protected if already paid
- ZIBA absorbs loss if required
- All actions logged

3) Chargebacks DO NOT auto-refund
Refunds remain a separate controlled process (Phase 10A).

4) Reconciliation Rules:
- expectedAmount = internal trip fare
- actualAmount = gateway report
- variance â‰  0 â†’ MANUAL_REVIEW

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
API ROUTES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

POST   /api/chargebacks/report
POST   /api/chargebacks/resolve
GET    /api/chargebacks?status=
POST   /api/reconciliation/run
GET    /api/reconciliation?status=

Strict RBAC at API level.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
UI (ADMIN / FINANCE ONLY)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Add a new Admin tab:

ðŸ’³ Chargebacks

Sections:
1) Chargeback Queue
   - Status filter
   - Trip ID
   - Amount
   - Provider
   - Status badge

2) Chargeback Detail Drawer
   - Trip summary
   - External reference
   - Resolution buttons
   - Audit timeline

3) Reconciliation Panel
   - Matched vs mismatched
   - Manual review actions

NO rider-facing UI yet.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
AUDIT & SAFETY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â€¢ Every action must log to AuditLog
â€¢ No silent balance changes
â€¢ No deletion of financial records
â€¢ No automatic payouts reversal

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FINAL CHECKS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â€¢ Prisma migrate runs clean
â€¢ Existing refunds still function
â€¢ Trips, payouts, wallets remain stable
â€¢ App compiles without errors

IMPLEMENT PHASE 10B ONLY.
